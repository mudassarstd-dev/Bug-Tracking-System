<form [formGroup]="bugForm" (ngSubmit)="save()" class="bug-dialog">

    <!-- Top Bar -->
    <div class="dialog-topbar">
        <div class="close-bg">
            <button mat-icon-button class="close-btn" (click)="close()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>

    <!-- Title -->
    <div class="dialog-title">Add New Bug</div>
    <hr class="divider" />

    <!-- Assignees + Due Date Row -->
    <div class="assign-due-row">
        <!-- Assignees -->
        <div class="assignees-section">
            <span class="label">Assign To</span>


            <!-- <div class="avatars">
        <img *ngFor="let user of assignees" [src]="user.avatar" class="avatar" />
        <button mat-mini-fab color="primary" class="add-avatar">
          <mat-icon>add</mat-icon>
        </button>
      </div> -->


            <!-- <div class="avatars">
                <img *ngFor="let user of bugForm.get('assignees')?.value" [src]="user.avatar" class="avatar" /> -->

            <!-- Add button opens dev menu -->
            <!-- <button mat-mini-fab color="primary" [matMenuTriggerFor]="devMenu" class="add-avatar">
                    <mat-icon>add</mat-icon>
                </button> -->

            <!-- Dropdown -->
            <!-- <div class="custom-dropdown-card" *ngIf="dropdownOpen"
                    [ngStyle]="{ top: dropdownPosition.top + 'px', left: dropdownPosition.left + 'px' }">
                    <div class="dropdown-title">Assign To</div>
                    <hr class="dropdown-divider" />

                    <div class="dropdown-list">
                        <div class="dropdown-item" *ngFor="let user of allUsers" (click)="toggleAssignee(user)">
                            <img [src]="user.avatar" alt="avatar" class="avatar" />
                            <span class="name">{{ user.name }}</span>
                            <mat-checkbox [checked]="isAssigned(user)" color="primary"
                                (click)="$event.stopPropagation(); toggleAssignee(user)"></mat-checkbox>
                        </div>
                    </div>
                </div>

            </div> -->

            <!-- Developer dropdown menu -->
            <!-- <mat-menu #devMenu="matMenu" class="dev-menu">
                <div class="menu-title">Assign Developers</div> -->
            <!-- <mat-divider></mat-divider> -->

            <!-- <button mat-menu-item *ngFor="let dev of assignees" (click)="toggleAssignee(dev)">
                    <img [src]="dev.avatar" class="avatar-small" />
                    <span class="dev-name">{{ dev.name }}</span>
                    <mat-checkbox [checked]="isSelected(dev)" (click)="$event.stopPropagation()"
                        color="primary"></mat-checkbox>
                </button>
            </mat-menu>
        </div> -->

            <div class="avatars">
                <!-- Avatars stack left â†’ right -->
                <img *ngFor="let user of bugForm.get('assignees')?.value" [src]="user.avatar" class="avatar" />

                <!-- Custom add button -->
                <button type="button" class="add-avatar hollow-add"
                    (click)="openDropdown($event); $event.stopPropagation()">
                    <div class="plus-badge">
                        <mat-icon>add</mat-icon>
                    </div>
                </button>
            </div>

            <!-- Custom Dropdown -->
            <div class="custom-dropdown-card" *ngIf="dropdownOpen" [ngStyle]="{
      top: dropdownPosition.top + 'px',
      left: dropdownPosition.left + 'px'
    }" (click)="$event.stopPropagation()">
                <div class="dropdown-title">Assign To</div>
                <hr class="dropdown-divider" />

                <div class="dropdown-list">
                    <div class="dropdown-item" *ngFor="let user of allUsers" (click)="toggleAssignee(user)">
                        <img [src]="user.avatar" alt="avatar" class="avatar" />
                        <span class="name">{{ user.name }}</span>
                        <mat-checkbox [checked]="isSelected(user)" color="primary"
                            (click)="$event.stopPropagation(); toggleAssignee(user)"></mat-checkbox>
                    </div>
                </div>
            </div>
        </div>

        <!-- Due Date -->
        <div class="due-date-section">
            <span class="label">Add Due Date</span>

            <!-- Calendar icon to open picker -->
            <!-- <button mat-icon-button color="primary" (click)="openDatePicker()">
                <mat-icon>calendar_today</mat-icon>
            </button> -->


            <img src="assets/icons/calendar.png" alt="calendar" width="32" height="32" class="calendar-icon"
                (click)="openDatePicker()">



            <!-- Selected date text -->
            <span class="selected-date" *ngIf="bugForm.get('dueDate')?.value">
                {{ bugForm.get('dueDate')?.value | date: 'mediumDate' }}
            </span>

            <!-- Hidden input linked to datepicker -->
            <input matInput [matDatepicker]="picker" [min]="minDate" formControlName="dueDate" hidden />

            <!-- Actual datepicker -->
            <mat-datepicker #picker (closed)="onDatePicked(picker._selected)"></mat-datepicker>
        </div>
    </div>

    <mat-error *ngIf="bugForm.get('dueDate')?.hasError('pastDate')">
        Due date cannot be in the past
    </mat-error>


    <!-- Bug Title Input -->
    <div class="bug-title-input">
        <input matInput formControlName="title" placeholder="Add title here" />
        <mat-error *ngIf="bugForm.get('title')?.touched && bugForm.get('title')?.invalid">
            Bug title is required
        </mat-error>
    </div>
    <!-- Bug Details -->
    <!-- <mat-form-field appearance="outline" class="bug-details-field" floatLabel="always">
        <mat-label>Bug Details</mat-label>
        <textarea matInput formControlName="details" rows="4" placeholder="Describe the issue..."></textarea>
    </mat-form-field> -->

    <div class="form-field">
        <label class="field-label">Bug Details</label>
        <input matInput formControlName="details" placeholder="Add here" />
    </div>


    <!-- Drop Image Section -->
    <!-- <div class="drop-zone" (click)="fileInput.click()">
        <mat-icon>cloud_upload</mat-icon>
        <p *ngIf="!selectedFile">Drag & drop image here or <span class="browse">browse</span></p>
        <p *ngIf="selectedFile"><strong>{{ selectedFile.name }}</strong></p>
        <input type="file" #fileInput hidden (change)="onFileSelected($event)" accept="image/*" />
    </div> -->

    <!-- Drop Image Section -->
    <div class="drop-zone" (click)="fileInput.click()">
        <ng-container *ngIf="!previewUrl; else imagePreview">
            <!-- <mat-icon>cloud_upload</mat-icon> -->
            <img src="assets/icons/image-drop.png" alt="upload-img" width="32" height="32">
            <p *ngIf="!selectedFile">
                Drag & drop image here or <span class="browse">browse</span>
            </p>
        </ng-container>

        <ng-template #imagePreview>
            <img [src]="previewUrl" alt="Preview" class="preview-image" />
        </ng-template>

        <input type="file" #fileInput hidden (change)="onFileSelected($event)" accept="image/*" />
    </div>

    <!-- Footer -->
    <div class="dialog-footer">
        <button mat-flat-button color="primary" type="submit">Add</button>
    </div>
</form>