<div class="sub-navbar mat-elevation-z0">

    <div class="subnav-left">

        <div class="titles">
            <p> <span style="color: #5B6871;"> Projects > </span> {{ projectTitle }} </p>
            <div class="hor-section">
                <div class="title">All Bug Listings</div>
                <span class="top-chip">Bugs</span>
            </div>
        </div>
    </div>

    <div class="subnav-right">

        <button mat-flat-button color="primary" *ngIf="isQa" (click)="openBugDialog()">
            <mat-icon>add</mat-icon>
            Add New Bug
        </button>
    </div>
</div>
<hr class="navbar-divider" />

<div class="search-filter-section">
    <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search projects</mat-label>
        <input matInput placeholder="Search..." (input)="applyFilter($event)" />
        <button mat-icon-button matPrefix>
            <mat-icon>search</mat-icon>
        </button>
    </mat-form-field>

    <div class="space"></div>

    <!-- <button mat-button>
        Click Me
        <mat-icon>arrow-down</mat-icon>
    </button> -->

    <div class="icon-section">

        <img src="assets/icons/filter.png" width="32" height="32" [class.active]="isFilterActive"
            [matMenuTriggerFor]="filterMenu" />

        <img src="assets/icons/sort.png" width="32" height="32" [class.active]="isSortActive"
            [matMenuTriggerFor]="sortMenu" />

        <img src="assets/icons/disabled-grid-view.png" width="32" height="32" [class.active]="isGridView"
            (click)="toggleView('grid')" />
        <img src="assets/icons/list-view.png" width="32" height="32" [class.active]="!isGridView"
            (click)="toggleView('list')" />
    </div>

    <!-- FILTER MENU -->
    <mat-menu #filterMenu="matMenu" id="filter-menu">
        <button mat-menu-item (click)="filterBugs('assignedToMe')" *ngIf="!isQa">Assigned to Me</button>
        <button mat-menu-item (click)="filterBugs('createdByMe')" *ngIf="isQa">Created by Me</button>
        <!-- <button mat-menu-item (click)="filterByStatus('New')">Status: New</button>
        <button mat-menu-item (click)="filterByStatus('Started')">Status: Started</button>
        <button mat-menu-item (click)="filterByStatus('Resolved')">Status: Resolved</button> -->
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="clearFilters(1)">Clear Filters</button>
    </mat-menu>

    <!-- SORT MENU -->
    <mat-menu #sortMenu="matMenu" id="sort-menu">
        <button mat-menu-item (click)="sortBugs('latest')">Sort by Latest Due Date</button>
        <button mat-menu-item (click)="sortBugs('nearest')">Sort by Nearest Due Date</button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="clearFilters(2)">Clear Filters</button>
    </mat-menu>

</div>

<hr class="navbar-divider" />

<div class="scroll-container">
    <div class="table-wrap" *ngIf="!isGridView">
        <table mat-table [dataSource]="dataSource" class="custom-material-table">

            <!-- BUG DETAILS -->
            <ng-container matColumnDef="details">
                <th mat-header-cell *matHeaderCellDef class="custom-header bug-details-header">Bug Details</th>
                <td mat-cell *matCellDef="let bug" class="custom-cell text-center">
                    <div class="bug-details">
                        <span class="bug-icon" [ngStyle]="{ 'background-color': getColor(bug.status) }"></span>
                        <span class="bug-title">{{ bug.details }}</span>
                    </div>
                </td>
            </ng-container>

            <!-- STATUS -->
            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef class="custom-header text-center">Status</th>
                <td mat-cell *matCellDef="let bug" class="custom-cell text-center">
                    <span class="status-chip" [ngClass]="bug.status | lowercase">{{ bug.status }}</span>
                </td>
            </ng-container>

            <!-- DUE DATE -->
            <ng-container matColumnDef="dueDate">
                <th mat-header-cell *matHeaderCellDef class="custom-header text-center">Due Date</th>
                <td mat-cell *matCellDef="let bug" class="custom-cell text-center">
                    <mat-icon class="calendar-icon" [matTooltip]="bug.dueDate | date: 'mediumDate'"
                        matTooltipPosition="above">
                        calendar_today
                    </mat-icon>
                </td>
            </ng-container>


            <!-- ASSIGNED TO -->
            <ng-container matColumnDef="assignedTo">
                <th mat-header-cell *matHeaderCellDef class="custom-header text-center">Assigned To</th>
                <td mat-cell *matCellDef="let bug" class="custom-cell text-center">
                    <div class="avatar-stack">
                        <ng-container *ngFor="let assignee of bug.assignees; let i = index">
                            <img [src]="assignee.avatar" [alt]="'user ' + i" class="avatar"
                                [style.zIndex]="bug.assignees.length - i" />
                        </ng-container>
                    </div>
                </td>
            </ng-container>

            <!-- ACTIONS -->
            <!-- <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="custom-header text-center">Actions</th>
            <td mat-cell *matCellDef="let bug" class="custom-cell text-center">
                <button mat-icon-button (click)="onActionClick(bug)">
                    <mat-icon>more_vert</mat-icon>
                </button>
            </td>
        </ng-container> -->

            <!-- ACTIONS -->

            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="custom-header text-center">Actions</th>
                <td mat-cell *matCellDef="let bug" class="custom-cell text-center action-cell">
                    <button mat-icon-button (click)="toggleDropdown(bug, $event)">
                        <mat-icon>more_vert</mat-icon>
                    </button>
                </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="data-row" (click)="onRowClick(row)">
            </tr>


            <!-- <thead mat-header-row *matHeaderRowDef="displayedColumns" class="header-row"></thead>
        <tbody mat-row *matRowDef="let row; columns: displayedColumns;" class="data-row"></tbody> -->
        </table>
    </div>
</div>

<!-- GLOBAL DROPDOWN (floats over everything) -->
<div class="global-dropdown" *ngIf="activeBug"
    [ngStyle]="{ top: dropdownPosition.top + 'px', left: dropdownPosition.left + 'px' }">
    <div class="dropdown-title">Change Status</div>

    <div class="dropdown-option chip-option" *ngFor="let status of statusOptions"
        (click)="updateStatus(activeBug.id, status)" [class.disabled]="!activeBug?.canUpdate">
        <span class="status-chip" [ngClass]="status.toLowerCase()">{{ status }}</span>
    </div>

    <hr class="dropdown-divider" />

    <!-- <div class="dropdown-option delete" (click)="onActionClick(activeBug)">
        Delete
        <mat-icon>delete_outline</mat-icon>
    </div> -->


    <div class="dropdown-option delete" [class.disabled]="!activeBug?.canDelete"
        (click)="activeBug?.canDelete && onActionClick(activeBug)">
        Delete
        <mat-icon>delete_outline</mat-icon>
    </div>
</div>


<!-- GRID VIEW -->
<div class="scroll-container">

    <div class="grid-view" *ngIf="isGridView">
        <mat-card class="bug-card" *ngFor="let bug of bugDetails">
            <mat-card-header>
                <mat-card-title>{{ bug.details }}</mat-card-title>
                <button mat-icon-button (click)="toggleDropdown(bug, $event)" class="more-btn">
                    <mat-icon>more_vert</mat-icon>
                </button>
            </mat-card-header>

            <span class="status-chip" [ngClass]="bug.status | lowercase">{{ bug.status }}</span>

            <div class="divider"></div>

            <mat-card-content>
                <div class="info-row">
                    <div class="label">Due Date</div>
                    <div class="value">{{ bug.dueDate | date: 'mediumDate' }}</div>
                </div>

                <div class="info-row">
                    <div class="label">Assigned To</div>
                    <div class="avatar-stack">
                        <ng-container *ngFor="let assignee of bug.assignees; let i = index">
                            <img [src]="assignee.avatar" [alt]="'user ' + i" class="avatar"
                                [style.zIndex]="bug.assignees.length - i" />
                        </ng-container>
                    </div>
                </div>
            </mat-card-content>

            <div class="divider"></div>

            <mat-card-actions>
                <button mat-flat-button class="details-btn" (click)="openUpdateBugDialog(bug.id)">
                    View Details
                </button>
            </mat-card-actions>
        </mat-card>
    </div>
</div>